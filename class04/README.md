# 4回

## ファイルシステムはどうやって作る?

比較的、理解しやすいファイルシステムを学ぶ。

### ファイルシステムの機能

1. 記憶媒体にデータのまとまりを保存。
2. 記憶媒体に含まれるデータを利用(読み取り)

### 記憶装置

電源を切っても記憶が残っている記憶装置。

- HDD
- CD, DVD, BD
- フラッシュメモリ

-> いろいろ種類がある.

### IO(Input/Output)

- ハードディスクなどの二次記憶装置はソフトウェアから直接利用できない。
- 2次記憶装置とソフトウェアのやりとりが必要になったら、1次記憶を介してIOを行う。
- デバイスドライバはOSの一つのモジュールとして動作。役割はIOである。

Linuxのソースは膨大。デバドラはベンダーが書いて公開している。そうしないと使ってもらえない。Linuxのソースコードは影響力が大きい。

### コンピュータを構成する要素(CPU/IO装置/2次記憶装置)

機械命令のたびに1回〜数回のメモリアクセスが起きる。

大雑把に言えば1クロックに1命令くらい。1Gクロック超えているはず。

2Gなら 2\*10^9 くらいだから、20億回は発生する。

→ これだと大変だから、CPUキャッシュを使って「ためて」アクセスすることで効率化.

---

- CPU
- RAM
- IO

**例えばNICなら...**

パケットのIOにはRAMを使う。NICから来たパケットをRAMにのせるのが受信。CPUからRAMにのせてNICへ送れば送信。これらによって送受信が出来る。

**HDDは動き出すまでが遅い。なぜだろう?**

IOの速度の差

- RAM: 10^(-9) sec
- HDD: 10^(-3) sec

内部にメカ（モータ）があるからタイムラグが起きている

速度に100万倍の差が出る。これは車の速度で考えても恐ろしい。

これらの時間差をうめる、調整するためにOSが必要になってくる。

> [重要]
> HDD は キロ のオーダで動いている
> CPU は ギガ のオーダで動いている

**割り込み**(ハードの仕組み)を利用してIO装置からCPUへ知らせが来る。これを受け取るのはCPUのデバイスドライバがやる。受け取ったものを他のアプリケーションに伝える。

**デバイスドライバの役割**

1. コマンドだして(コマンドレジスタ)
2. DMA(Direct Memory Access)
3. 割り込み

### HDD

磁石の点をビット数の分だけ置く必要がある。垂直磁気記憶の研究をしていたのは日本人。

ヘッドとディスクの間はタバコの煙の粒子よりも細かい間隔で離れている。開けたらゴミ入って終わり。

> [重要]
> 回転している
> ヘッドというセンサが動く（これを**シーク**と呼ぶ)
> CPUと比べれば遅い

### HDDのIO

1. シーク(ヘッドを対象シリンダまで移動)
2. 回転待ち時間(ヘッドの下に対象セクタがやってくるのを待つ)
3. ヘッドによってディスク上の磁気データを読み取ったり、書き込んだりする

### ソフトウェアのIO処理

以下を繰り返すのがデバイスドライバ

> スライドp11参照

### ファイルシステムの階層

ファイルシステムの種類は多くある。ファイルシステムはそれぞれ構造が異なっているから相互対応はできない。

- デバイスドライバ
- 物理ファイルシステム(FAT, NTFS, ext4)
- 論理ファイルシステム(VFS)

> [重要] 大きなソフトウェアを作成する場合は階層的に分割するアプローチをすることが多くある.

実はLinuxは知らないファイルシステムは自分で調べて追加する機能がある。

hddを接続したときにOSはファイルシステムを識別している。

**動画像をダウンロードした時...**

ファイルをダウンロードした時、hddの空き領域を探す.

どこにデータが保存されているか、空いているかを判断して保存する.

### ファイルをハードディスクに保存

2つの保存の仕方

1. ディスク上の連続した場所に保存する方法
2. **固定サイズのとびとびの場所に保存する方法**

**フラグメンテーション**

10GBの空き領域に5GBのファイルが置かれる。ここに追加で0.1GBのデータを置く。次に5GBのファイルを削除すると10GBの中央部に0.1GBのデータが残ってしまう。この状況を**フラグメンテーション**と呼ぶ。

- メタデータをinodeと呼ぶ.(例えば｀ls -i`とやるとinode番号を表示させることが出来る。
- `struct inode`で定義されている.
